{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Dromedary demo - iam roles & policies and instance-profiles",

    "Resources": {

        "InstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [{
                        "Effect": "Allow",
                        "Principal": { "Service": [ "ec2.amazonaws.com" ]},
                        "Action": [ "sts:AssumeRole" ]
                    }]
                },
                "Path": "/",
                "Policies": [{
                    "PolicyName": "AllowAll",
                    "PolicyDocument": {
                        "Statement": [{
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }]
                    }
                }]
            }
        },

        "InstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [{ "Ref": "InstanceRole" }]
            }
        },

        "CodeDeployTrustRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [{
                        "Sid": "1",
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [
                                "codedeploy.us-east-1.amazonaws.com",
                                "codedeploy.us-west-2.amazonaws.com"
                            ]
                        },
                        "Action": "sts:AssumeRole"
                    }]
                },
                "Path": "/",
                "Policies": [{
                    "PolicyName": "CodeDeployPolicy",
                    "PolicyDocument": {
                        "Statement": [{
                            "Effect": "Allow",
                            "Action": [ "ec2:Describe*" ],
                            "Resource": [ "*" ]
                        },{
                            "Effect": "Allow",
                            "Resource": [ "*" ],
                            "Action": [
                                "autoscaling:CompleteLifecycleAction",
                                "autoscaling:DeleteLifecycleHook",
                                "autoscaling:DescribeLifecycleHooks",
                                "autoscaling:DescribeAutoScalingGroups",
                                "autoscaling:PutLifecycleHook",
                                "autoscaling:RecordLifecycleActionHeartbeat"
                            ]
                        }]
                    }
                }]
            }
        }
    },

    "Outputs": {
        "CodeDeployServiceRoleARN": {
            "Description": "The ARN of the Code Deploy Trust Role, which is needed to configure Code Deploy",
            "Value": { "Fn::GetAtt": [ "CodeDeployTrustRole", "Arn" ]}
        },
        "InstanceProfile": {
            "Description": "Name if instance-profile for Jenkins and application instances",
            "Value": { "Ref": "InstanceProfile" }
        },
        "InstanceRole": {
            "Description": "IAM Role for Jenkins and application instance profile",
            "Value": { "Ref": "InstanceRole" }
        }
    }
}
