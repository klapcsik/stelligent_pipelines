{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Dromedary demo - application instance",

    "Parameters" : {
        "Ec2Key": {
            "Type": "String",
            "Description": "Ec2 key for ssh access",
            "Default": ""
        },
        "SubnetId": {
            "Type": "String",
            "Description": "VPC subnet id in which to place instance"
        },
        "VPC": {
            "Type": "String",
            "Description": "VPC id in which to place instance"
        },
        "CfnInitRole": {
            "Type": "String",
            "Description": "IAM Role for cfn-init"
        },
        "InstanceProfile": {
            "Type": "String",
            "Description": "Instance profile for app instance"
        },
        "S3Bucket": {
            "Type": "String",
            "Description": "Artifact Bucket"
        },
        "ArtifactPath": {
            "Type": "String",
            "Description": "Path to tarabll in Artifact Bucket",
            "Default": ""
        },
        "CodeDeployTag": {
            "Type": "String",
            "Description": "Resource Tags for Deployment Group",
            "Default": ""
        }
    },

    "Conditions": {
        "NoEc2Key": { "Fn::Equals" : [ { "Ref" : "Ec2Key" }, "" ]},
        "InstallCodeDeploy": { "Fn::Not" : [{ "Fn::Equals" : [ { "Ref" : "CodeDeployTag" }, "" ]} ]},
        "DeployFromS3": { "Fn::Not" : [{ "Fn::Equals" : [ { "Ref" : "ArtifactPath" }, "" ]} ]}
    },

    "Mappings": {
        "RegionConfig": {
            "us-east-1": {
                "ami": "ami-0d4cfd66"
            },
            "us-west-2": {
                "ami": "ami-d5c5d1e5"
            }
        }
    },

    "Resources": {
        "InstanceSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "VpcId": { "Ref": "VPC" },
                "GroupDescription": "Enable SSH access via port 22",
                "SecurityGroupIngress": [
                    { "IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0" },
                    { "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": "0.0.0.0/0" },
                    { "IpProtocol": "tcp", "FromPort": "8080", "ToPort": "8080", "CidrIp": "0.0.0.0/0" }
                ]
            }
        },

        "WebServerInstance": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {
                "AWS::CloudFormation::Authentication" : {
                    "S3AccessCreds" : {
                        "type" : "S3",
                        "roleName" : { "Ref" : "CfnInitRole" },
                        "buckets" : [{ "Ref" : "S3Bucket" }]
                    }
                },
                "AWS::CloudFormation::Init": {
                    "configSets" : {
                        "base" : [ "base" ],
                        "codedeploy" : [ "codedeploy" ],
                        "s3" : [ "s3" ],
                        "default" : [ { "ConfigSet" : "base" }]
                    },
                    "base": {
                        "files": {
                            "/tmp/node-install.tar.gz": {
                                "source": "https://nodejs.org/dist/v0.12.7/node-v0.12.7-linux-x64.tar.gz",
                                "mode": "000644",
                                "owner": "root",
                                "group": "root"
                            }
                        },
                        "commands": {
                            "10-install-node": {
                                "test": "test \"$(/usr/local/bin/node --version 2>/dev/null)\" != 'v0.12.7'",
                                "command": { "Fn::Join" : [ "", [
                                    "yum remove -y nodejs npm\n",
                                    "\n",
                                    "cd /usr/local && tar --strip-components 1 -xzf /tmp/node-install.tar.gz\n",
                                    "if [ ! -e /usr/bin/node ]; then\n",
                                    "  ln -s /usr/local/bin/node /usr/bin/node\n",
                                    "fi\n",
                                    "if [ ! -e /usr/bin/npm ]; then\n",
                                    "  ln -s /usr/local/bin/npm /usr/bin/npm\n",
                                    "fi\n"
                                ]]}
                            },
                            "15-install-node-modules": {
                                "command": "npm install -g forever"
                            }
                        }
                    },
                    "codedeploy": {
                        "package": {
                            "yum": {
                                "ruby": []
                            }
                        },
                        "files": {
                            "/tmp/codedeploy-install": {
                                "source": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/aws-codedeploy-", {"Ref": "AWS::Region"}, "/latest/install" ]]},
                                "mode": "000755",
                                "owner": "root",
                                "group": "root"
                            }
                        },
                        "commands": {
                            "10-install-codedeploy": {
                                "cwd": "/tmp",
                                "command": "./install auto\n"
                            }
                        }
                    },
                    "s3": {
                        "files": {
                            "/tmp/dromedary.tgz": {
                                "source": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref" : "S3Bucket" }, "/", { "Ref": "ArtifactPath" } ]]},
                                "authentication": "S3AccessCreds",
                                "mode": "000644",
                                "owner": "root",
                                "group": "root"
                            }
                        },
                        "commands": {
                            "00-extract-dromedary": {
                                "command": { "Fn::Join" : [ "", [
                                    "mkdir -p -m755 /dromedary/log\n",
                                    "cd /dromedary\n",
                                    "tar xzf /tmp/dromedary.tgz\n"
                                ]]}
                            },
                            "10-start-node": {
                                "cwd": "/dromedary",
                                "command": "/usr/bin/forever app.js > /dromedary/log/server.log 2>&1 &\n"
                            }
                        }
                    }
                }
            },
            "Properties": {
                "ImageId": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "ami" ]},
                "InstanceType": "t2.large",
                "IamInstanceProfile": { "Ref": "InstanceProfile" },
                "KeyName": { "Fn::If": [ "NoEc2Key", { "Ref": "AWS::NoValue" }, { "Ref": "Ec2Key" } ]},
                "Tags": { "Fn::If": [ "InstallCodeDeploy",
                    [{ "Key": "Application", "Value": { "Ref": "AWS::StackId" }},
                     { "Key": "Name", "Value": "DromedaryApp" },
                     { "Key": "environment", "Value": "dromedary" }],
                    [{ "Key": "Application", "Value": { "Ref": "AWS::StackId" }},
                     { "Key": "Name", "Value": "DromedaryApp" }]
                ]},
                "NetworkInterfaces": [{
                    "GroupSet": [{ "Ref": "InstanceSecurityGroup" }],
                    "AssociatePublicIpAddress": "true",
                    "DeviceIndex": "0",
                    "DeleteOnTermination": "true",
                    "SubnetId": { "Ref": "SubnetId" }
                }],
                "UserData": { "Fn::Base64": { "Fn::Join": [ "", [
                    "#!/bin/bash -xe\n",
                    "yum update -y aws-cfn-bootstrap\n",
                    "yum -y upgrade\n",
                    "\n",
                    { "Fn::If": [ "InstallCodeDeploy", 
                        "cfn_configsets='base,codedeploy'\n",
                        "cfn_configsets='default'\n"
                    ]},
                    { "Fn::If": [ "DeployFromS3", 
                        "cfn_configsets='base,s3'\n",
                        "cfn_configsets='default'\n"
                    ]},
                    "/opt/aws/bin/cfn-init -v --configsets $cfn_configsets",
                      " --stack ", {"Ref": "AWS::StackName"},
                      " --resource WebServerInstance ",
                      " --role ", {"Ref": "CfnInitRole"},
                      " --region ", {"Ref": "AWS::Region"},
                      "\n",
                    "\n",
                    "node -v \n",
                    "npm -v\n",
                    "\n",
                    "/opt/aws/bin/cfn-signal -e $? ",
                      " --stack ", {"Ref": "AWS::StackName"},
                      " --resource WebServerInstance ",
                      " --region ", {"Ref": "AWS::Region"},
                      "\n"
                ]]}}
            },
            "CreationPolicy": {
                "ResourceSignal": { "Timeout": "PT15M" }
            }
        }
    },

    "Outputs": {
        "PublicDns": {
            "Description": "Public DNS of Dromedary App instance",
            "Value": { "Fn::GetAtt": [ "WebServerInstance", "PublicIp" ]}
        }
    }
}
