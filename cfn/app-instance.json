{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Dromedary demo - application instance",

    "Parameters" : {
        "Ec2Key": {
            "Type": "String",
            "Description": "Ec2 key for ssh access"
        },
        "SubnetId": {
            "Type": "String",
            "Description": "VPC subnet id in which to place instance"
        },
        "SecurityGroupId": {
            "Type": "String",
            "Description": "Security-group id in which to place instance"
        },
        "InstanceProfile": {
            "Type": "String",
            "Description": "Instance profile for app instance"
        }
    },

    "Mappings": {
        "RegionConfig": {
            "us-east-1": {
                "ami": "ami-0d4cfd66"
            },
            "us-west-2": {
                "ami": "ami-d5c5d1e5"
            }
        }
    },

    "Resources": {

        "WebServerInstance": {
            "Type": "AWS::EC2::Instance",
            "Metadata": {

                "AWS::CloudFormation::Init": {
                    "config": {
                        "packages": {
                            "yum": {
                                "httpd": []
                            }
                        },
                        "files": {
                            "/var/www/html/index.html": {
                                "content": { "Fn::Join": [ "\n", [
                                    "<h1>Congratulations, you have successfully launched the AWS CloudFormation sample.</h1>"
                                ]]},
                                "mode": "000644",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/cfn/cfn-hup.conf": {
                                "content": { "Fn::Join": [ "", [
                                    "[main]\n",
                                    "stack=", { "Ref": "AWS::StackId" }, "\n",
                                    "region=", { "Ref": "AWS::Region" }, "\n"
                                ]]},
                                "mode": "000400",
                                "owner": "root",
                                "group": "root"
                            },
                            "/etc/cfn/hooks.d/cfn-auto-reloader.conf": {
                                "content": { "Fn::Join": [ "", [
                                    "[cfn-auto-reloader-hook]\n",
                                    "triggers=post.update\n",
                                    "path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init\n",
                                    "action=/opt/aws/bin/cfn-init -v",
                                      " --stack ", { "Ref": "AWS::StackName" },
                                      " --resource WebServerInstance ",
                                      " --region ", { "Ref": "AWS::Region" },
                                      "\n",
                                      "runas=root\n"
                                ]]}
                            }
                        },
                        "services": {
                            "sysvinit": {
                                "httpd": {
                                    "enabled": "true",
                                    "ensureRunning": "true"
                                },
                                "cfn-hup": {
                                    "enabled": "true",
                                    "ensureRunning": "true",
                                    "files": [
                                        "/etc/cfn/cfn-hup.conf",
                                        "/etc/cfn/hooks.d/cfn-auto-reloader.conf"
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "Properties": {
                "ImageId": { "Fn::FindInMap": [ "RegionConfig", { "Ref": "AWS::Region" }, "ami" ]},
                "InstanceType": "t2.large",
                "IamInstanceProfile": { "Ref": "InstanceProfile" },
                "KeyName": { "Ref": "Ec2Key" },
                "Tags": [{ "Key": "Application", "Value": { "Ref": "AWS::StackId" }},
                         { "Key": "environment", "Value": "dromedary" }],
                "NetworkInterfaces": [{
                    "GroupSet": [{ "Ref": "SecurityGroupId" }],
                    "AssociatePublicIpAddress": "true",
                    "DeviceIndex": "0",
                    "DeleteOnTermination": "true",
                    "SubnetId": { "Ref": "SubnetId" }
                }],
                "UserData": { "Fn::Base64": { "Fn::Join": [ "", [
                    "#!/bin/bash -xe\n",
                    "yum update -y aws-cfn-bootstrap\n",
                    "yum -y update\n",
                    "yum -y install ruby aws-cli\n",
                    "yum -y install nodejs npm --enablerepo=epel\n",
                    "npm install -g gulp\n",
                    "npm install -g forever\n",
                    "pushd /home/ec2-user\n",
                    "aws s3 cp s3://aws-codedeploy-", {"Ref": "AWS::Region"}, "/latest/install . --region ", {"Ref": "AWS::Region"}, "\n",
                    "chmod +x ./install\n",
                    "./install auto\n",
                    "popd\n",
                    "/opt/aws/bin/cfn-init -v",
                      " --stack ", {"Ref": "AWS::StackName"},
                      " --resource WebServerInstance ",
                      " --region ", {"Ref": "AWS::Region"},
                      "\n",
                    "/opt/aws/bin/cfn-signal -e $? ",
                      " --stack ", {"Ref": "AWS::StackName"},
                      " --resource WebServerInstance ",
                      " --region ", {"Ref": "AWS::Region"},
                      "\n"
                ]]}}
            },
            "CreationPolicy": {
                "ResourceSignal": { "Timeout": "PT15M" }
            }
        }
    }
}
